<!DOCTYPE html>
<html>
<head>
    <title>Manual Letter Test</title>
</head>
<body>
    <h1>Manual Letter Flow Test</h1>
    <div id="results"></div>

    <script type="module">
        const results = document.getElementById('results');

        async function testLetterFlow() {
            results.innerHTML = '<h2>Testing Letter Flow...</h2>';

            try {
                // Step 1: Create invoice with letter
                results.innerHTML += '<h3>Step 1: Creating invoice with letter...</h3>';
                const invoiceResponse = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        x: 999,
                        y: 999,
                        color: '#ff0000',
                        letter: 'X'
                    })
                });

                if (!invoiceResponse.ok) {
                    results.innerHTML += `<p style="color: red;">❌ Invoice creation failed: ${invoiceResponse.status}</p>`;
                    return;
                }

                const invoiceData = await invoiceResponse.json();
                results.innerHTML += `<p style="color: green;">✅ Invoice created: ${invoiceData.id}</p>`;
                results.innerHTML += `<p>Amount: ${invoiceData.amount} sats</p>`;
                results.innerHTML += `<p>Is Mock: ${invoiceData.isMock}</p>`;

                // Step 2: Simulate webhook completion
                results.innerHTML += '<h3>Step 2: Simulating webhook completion...</h3>';

                // For mock mode, we need to use the test endpoint or curl command
                if (invoiceData.isMock) {
                    results.innerHTML += '<p style="color: blue;">Mock mode detected - use this curl command to complete payment:</p>';
                    results.innerHTML += `<pre>curl -X POST http://localhost:3000/api/nakapay \\
  -H "Content-Type: application/json" \\
  -d '{"payment_hash": "${invoiceData.payment_hash || invoiceData.id}", "status": "completed"}'</pre>`;
                } else {
                    results.innerHTML += '<p style="color: orange;">Real payment mode - complete the payment using the invoice</p>';
                }

                // Step 3: Check if pixel was saved
                results.innerHTML += '<h3>Step 3: Checking if pixel was saved...</h3>';
                const pixelsResponse = await fetch(`/api/pixels?x1=995&y1=995&x2=1005&y2=1005`);

                if (pixelsResponse.ok) {
                    const pixels = await pixelsResponse.json();
                    const targetPixel = pixels.find(p => p.x === 999 && p.y === 999);

                    if (targetPixel) {
                        results.innerHTML += '<p style="color: green;">✅ Pixel found!</p>';
                        results.innerHTML += `<p>Color: ${targetPixel.color}</p>`;
                        results.innerHTML += `<p>Letter: "${targetPixel.letter || 'null'}"</p>`;
                        results.innerHTML += `<p>Sats: ${targetPixel.sats}</p>`;

                        if (targetPixel.letter === 'X') {
                            results.innerHTML += '<p style="color: green; font-weight: bold;">✅ SUCCESS: Letter was saved correctly!</p>';
                        } else {
                            results.innerHTML += '<p style="color: red;">❌ Letter was not saved correctly</p>';
                        }
                    } else {
                        results.innerHTML += '<p style="color: orange;">Pixel not found (payment may not be completed yet)</p>';
                        results.innerHTML += '<p>Available pixels in area:</p>';
                        pixels.forEach(p => {
                            results.innerHTML += `<p>  (${p.x}, ${p.y}): "${p.letter || ''}" - ${p.color}</p>`;
                        });
                    }
                } else {
                    results.innerHTML += '<p style="color: red;">❌ Failed to fetch pixels</p>';
                }

            } catch (error) {
                results.innerHTML += `<p style="color: red;">❌ Test failed: ${error.message}</p>`;
            }
        }

        // Run the test
        testLetterFlow();
    </script>
</body>
</html>